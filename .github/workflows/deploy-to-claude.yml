# .github/workflows/deploy-to-claude.yml
#
# Universal skill deployer — works with ANY repo structure.
# Finds every SKILL.md in the repo and deploys its parent folder as a skill.
#
# Examples of structures it handles:
#   SKILL.md (at root)
#   skills/my-skill/SKILL.md
#   n8n-code-javascript/SKILL.md
#   some/nested/path/SKILL.md
#
# Setup:
#   1. Copy to .github/workflows/deploy-to-claude.yml
#   2. Add ANTHROPIC_API_KEY as a repo secret
#   3. Push

name: Deploy Skills to Claude API

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - run: pip install anthropic

      - name: Deploy skills
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python - << 'SCRIPT'
          import os
          import json
          from pathlib import Path
          import anthropic
          from anthropic.lib import files_from_dir

          client = anthropic.Anthropic()
          beta = "skills-2025-10-02"
          ids_file = Path(".skill-ids.json")

          # Load existing skill ID mappings
          skill_ids = {}
          if ids_file.exists():
              skill_ids = json.loads(ids_file.read_text())

          # Find every SKILL.md in the repo
          skill_files = sorted(Path(".").rglob("SKILL.md"))

          # Skip anything inside .github, node_modules, test, etc.
          skip_dirs = {".github", "node_modules", ".git", "test", "tests"}
          skill_folders = []
          for sf in skill_files:
              parts = set(sf.parts)
              if not parts & skip_dirs:
                  skill_folders.append(sf.parent)

          if not skill_folders:
              print("No SKILL.md files found")
              exit(0)

          print(f"Found {len(skill_folders)} skill(s):\n")
          for f in skill_folders:
              print(f"  - {f}")
          print()

          for folder in skill_folders:
              # Use folder name as key, or repo name if SKILL.md is at root
              key = str(folder) if str(folder) != "." else os.path.basename(os.getcwd())
              print(f"{'='*50}")
              print(f"Deploying: {key}")

              # Read display title from SKILL.md frontmatter
              title = key
              try:
                  with open(folder / "SKILL.md") as f:
                      for line in f:
                          if line.strip().startswith("name:"):
                              title = line.split(":", 1)[1].strip().strip('"').strip("'")
                              break
              except Exception:
                  pass

              existing_id = skill_ids.get(key)

              try:
                  if existing_id:
                      print(f"  Updating existing skill: {existing_id}")
                      version = client.beta.skills.versions.create(
                          skill_id=existing_id,
                          files=files_from_dir(str(folder)),
                          betas=[beta],
                      )
                      print(f"  ✅ New version: {version.version}")
                  else:
                      print(f"  Creating new skill: {title}")
                      skill = client.beta.skills.create(
                          display_title=title,
                          files=files_from_dir(str(folder)),
                          betas=[beta],
                      )
                      skill_ids[key] = skill.id
                      print(f"  ✅ Created: {skill.id}")
              except Exception as e:
                  print(f"  ❌ Failed: {e}")

              print()

          # Save updated skill IDs
          ids_file.write_text(json.dumps(skill_ids, indent=2) + "\n")
          print(f"Saved skill IDs to {ids_file}")
          SCRIPT

      - name: Commit skill ID mappings
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .skill-ids.json
          git diff --cached --quiet || git commit -m "chore: update skill ID mappings"
          git push
